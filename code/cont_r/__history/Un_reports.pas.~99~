unit Un_reports;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs,ADODB,db, ComCtrls, StdCtrls, Grids, DBGrids, DBCtrls, ExtCtrls;

type
  TFrm_reports = class(TForm)
    reprotPC: TPageControl;
    perosnalcaseTab: TTabSheet;
    Stud_report1_inpBox: TGroupBox;
    Stud_report1cbBox: TGroupBox;
    Stud_report1btnbox: TGroupBox;
    stud_idCB: TCheckBox;
    b_dataCB: TCheckBox;
    SexCB: TCheckBox;
    civCB: TCheckBox;
    regionCB: TCheckBox;
    gorodCB: TCheckBox;
    adrCB: TCheckBox;
    fioCB: TCheckBox;
    dom_tCB: TCheckBox;
    data_prCB: TCheckBox;
    naim_grupCB: TCheckBox;
    st_emailCB: TCheckBox;
    to_liveCB: TCheckBox;
    mod_tCB: TCheckBox;
    Stud_report1databox: TGroupBox;
    Stud_report1Grid: TDBGrid;
    stud_repprt1_lbl: TStaticText;
    Stud_report1DBL: TDBLookupComboBox;
    Stud_report1Btn: TButton;
    Studlisttab: TTabSheet;
    Secondreport_groupBox: TGroupBox;
    Secondreport_data_inp: TGroupBox;
    SecondReportbtnBox: TGroupBox;
    seconreportBtn: TButton;
    r2cbId: TCheckBox;
    r2b_dataCB: TCheckBox;
    r2sexcb: TCheckBox;
    r2civCB: TCheckBox;
    r2regionCB: TCheckBox;
    r2gorodCB: TCheckBox;
    r2adrCB: TCheckBox;
    r2fioCB: TCheckBox;
    r2kursCB: TCheckBox;
    r2to_liveCB: TCheckBox;
    r2mod_tcb: TCheckBox;
    r2dom_tCB: TCheckBox;
    r2ox12CB: TCheckBox;
    r2naim_grupCB: TCheckBox;
    r2st_emailCB: TCheckBox;
    secondreport_databox: TGroupBox;
    secondrepotGrid: TDBGrid;
    grouplbl: TStaticText;
    r2groupDBL: TDBLookupComboBox;
    report2_datalbl: TStaticText;
    r2_date_inp: TDateTimePicker;
    procedure FormActivate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure Stud_report1BtnClick(Sender: TObject);
    procedure stud_idCBClick(Sender: TObject);
    procedure b_dataCBClick(Sender: TObject);
    procedure SexCBClick(Sender: TObject);
    procedure civCBClick(Sender: TObject);
    procedure regionCBClick(Sender: TObject);
    procedure gorodCBClick(Sender: TObject);
    procedure adrCBClick(Sender: TObject);
    procedure fioCBClick(Sender: TObject);
    procedure to_liveCBClick(Sender: TObject);
    procedure mod_tCBClick(Sender: TObject);
    procedure dom_tCBClick(Sender: TObject);
    procedure data_prCBClick(Sender: TObject);
    procedure naim_grupCBClick(Sender: TObject);
    procedure st_emailCBClick(Sender: TObject);
    procedure reprotPCChange(Sender: TObject);
    procedure seconreportBtnClick(Sender: TObject);
    procedure r2cbIdClick(Sender: TObject);
    procedure r2b_dataCBClick(Sender: TObject);
    procedure r2sexcbClick(Sender: TObject);
    procedure r2civCBClick(Sender: TObject);
    procedure r2regionCBClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Frm_reports: TFrm_reports;

implementation

uses Un_dm, Un_func;

{$R *.dfm}

procedure TFrm_reports.adrCBClick(Sender: TObject);
begin
  Stud_report1Grid.Columns[6].Visible:=adrCB.Checked;
  if adrCB.Checked then Stud_report1Grid.Columns[6].Title.Caption:='Адрес';
end;

procedure TFrm_reports.b_dataCBClick(Sender: TObject);
begin
 Stud_report1Grid.Columns[1].Visible:=b_dataCB.Checked;
 if b_dataCB.Checked then
    Stud_report1Grid.Columns[1].Title.Caption:='Дата рождения';
end;

procedure TFrm_reports.civCBClick(Sender: TObject);
begin
  Stud_report1Grid.Columns[3].Visible:=civCB.Checked;
  if civCB.Checked then
  Stud_report1Grid.Columns[3].Title.Caption:='Гражданство';
end;

procedure TFrm_reports.data_prCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[11].Visible:=data_prCB.Checked;
if data_prCB.Checked then
  Stud_report1Grid.Columns[11].Title.Caption:='Дата приема';
end;

procedure TFrm_reports.dom_tCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[10].Visible:=dom_tCB.Checked;
if dom_tCB.Checked then Stud_report1Grid.Columns[10].Title.Caption:='Домашний';
end;

procedure TFrm_reports.fioCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[7].Visible:=fioCB.Checked;
 if fioCB.Checked then  Stud_report1Grid.Columns[7].Title.Caption:='ФИО';
end;

procedure TFrm_reports.FormActivate(Sender: TObject);
var cb:Integer;
begin
  dm.reportQuery.SQL.Clear;
  dm.reportQuery.SQL.Text:= 'select '+
 '  stud.stud_id, ' +
    '  stud.b_data, ' +
    '  CASE stud.pol WHEN 1 THEN ''Мужской'' ELSE ''Женский'' END AS sex, ' +
    '  stud.civ, ' +
    '  stud.region, ' +
    '  stud.gorod, ' +
    '  stud.adr, ' +
    '  stud.passp_fam + '' '' + stud.passp_naim + ISNULL('' '' + stud.passp_otch, '''') AS fio, ' +
 '  CASE stud.mesto_jit WHEN 1 THEN ''Съем'' ELSE ''Общежитие'' END AS to_live, ' +
    '  stud.mod_t, ' +
    '  stud.dom_t, ' +
    '  stud.data_pr, ' +
    '  gruppa.naim_grup, ' +
    '  stud.st_email ' +
    'FROM stud ' +
    'INNER JOIN gruppa ON gruppa.grup_id = stud.grup_id ' +
    'INNER JOIN spec ON spec.spec_id = gruppa.spec_id ' +
    'WHERE 1=1 ' +
    '  AND stud.data_ot IS NULL ' +
    '  AND is_akadem = 0 ';
  dm.reportQuery.Open;
  dm.StudQuery.Open;
  dm.PrikazQuery.Open;
  dm.GruppQuery.Open;
  dm.specQuery.Open;
  Stud_report1Grid.Columns[0].Title.Caption := 'Номер порядковый';
  Stud_report1Grid.Columns[1].Title.Caption:='Дата рождения';
  Stud_report1Grid.Columns[2].Title.Caption:='Пол';
  Stud_report1Grid.Columns[3].Title.Caption:='Гражданство';
  Stud_report1Grid.Columns[4].Title.Caption:='Регион';
  Stud_report1Grid.Columns[5].Title.Caption:='Город';
  Stud_report1Grid.Columns[6].Title.Caption:='Адрес';
  Stud_report1Grid.Columns[7].Title.Caption:='ФИО';
  Stud_report1Grid.Columns[8].Title.Caption:='Проживание';
  Stud_report1Grid.Columns[9].Title.Caption:='Мобильный';
  Stud_report1Grid.Columns[10].Title.Caption:='Домашний';
  Stud_report1Grid.Columns[11].Title.Caption:='Дата приема';
  Stud_report1Grid.Columns[12].Title.Caption:='Группа';
  Stud_report1Grid.Columns[13].Title.Caption:='Email';
  with Frm_reports do
 begin
    for cb := 0 to ComponentCount - 1 do
 begin
    if(Components[cb] is TCheckBox)  then
   begin
      (Components[cb] as TCheckBox).Enabled:=false;
 end;
 end;
 end;

end;

procedure TFrm_reports.FormClose(Sender: TObject; var Action: TCloseAction);
var q,cb:Integer;
begin
 SaveFormState(Self);
 with dm do
 begin
    for q := 0 to ComponentCount - 1 do
 begin
    if(Components[q] is TADOQuery)  then
   begin
      (Components[q] as TADOQuery).Close;
 end;
 end;
 end;
 with Frm_reports do
 begin
    for cb := 0 to ComponentCount - 1 do
 begin
    if(Components[cb] is TCheckBox)  then
   begin
      (Components[cb] as TCheckBox).Checked:=False;
 end;
 end;
 end;

end;

procedure TFrm_reports.FormCreate(Sender: TObject);
  var cb:Integer;
begin
  UniformizeComponentSizes(Self, 998, 21, clWhite, 'Arial', 10);
 LoadFormState(Self);
  with Frm_reports do
 begin
    for cb := 0 to ComponentCount - 1 do
 begin
    if(Components[cb] is TCheckBox)  then
   begin
      (Components[cb] as TCheckBox).Checked:=False;
 end;
 end;
 end;
  reprotPC.ActivePage:=perosnalcaseTab;
end;

procedure TFrm_reports.gorodCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[5].Visible:=gorodCB.Checked;
if gorodCB.Checked then
  Stud_report1Grid.Columns[5].Title.Caption:='Город';
end;

procedure TFrm_reports.mod_tCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[9].Visible:=mod_tCB.Checked;
if mod_tCB.Checked then Stud_report1Grid.Columns[9].Title.Caption:='Мобильный';
end;

procedure TFrm_reports.naim_grupCBClick(Sender: TObject);
begin
 Stud_report1Grid.Columns[12].Visible:=naim_grupCB.Checked;
if naim_grupCB.Checked
then  Stud_report1Grid.Columns[12].Title.Caption:='Группа';
//if naim_grupCB then
//begin
//Stud_report1Grid.Columns[12].Visible;
//Stud_report1Grid.Columns[12].Caption:='Группа';
//end
//else
//begin
//Stud_report1Grid.Columns[12].Visible:=false
//end;
end;

procedure TFrm_reports.r2b_dataCBClick(Sender: TObject);
begin
secondrepotGrid.Columns[1].Visible:=r2b_dataCB.Checked;
if r2b_dataCB.Checked then
secondrepotGrid.Columns[1].Title.Caption:='Дата рождения'

end;

procedure TFrm_reports.r2cbIdClick(Sender: TObject);
begin
  secondrepotGrid.Columns[0].Visible:=r2cbId.Checked;
if r2cbId.Checked then
secondrepotGrid.Columns[0].Title.Caption:='Номер прядковый';
end;

procedure TFrm_reports.r2civCBClick(Sender: TObject);
begin
secondrepotGrid.Columns[3].Visible:=r2civCB.Checked;
if r2civCB.Checked then  secondrepotGrid.Columns[3].Title.Caption:='Гражданство';
end;

procedure TFrm_reports.r2regionCBClick(Sender: TObject);
begin
secondrepotGrid.Columns[4].Visible:=r2regionCB.Checked;
if r2regionCB.Checked then secondrepotGrid.Columns[4].Title.Caption:='Регион';
end;

procedure TFrm_reports.r2sexcbClick(Sender: TObject);
begin
    secondrepotGrid.Columns[2].Visible:=r2sexcb.Checked;
    if r2sexcb.Checked then secondrepotGrid.Columns[2].Title.Caption:='Пол';
end;

procedure TFrm_reports.regionCBClick(Sender: TObject);
begin
  Stud_report1Grid.Columns[4].Visible:=regionCB.Checked;
if regionCB.Checked then Stud_report1Grid.Columns[4].Title.Caption:='Регион';
end;

procedure TFrm_reports.reprotPCChange(Sender: TObject);
begin
 case reprotPC.TabIndex of
 0:
 begin
 with dm.reportQuery do
 begin
  SQL.Clear;
  SQL.Text:= 'select '+
 '  stud.stud_id, ' +
    '  stud.b_data, ' +
    '  CASE stud.pol WHEN 1 THEN ''Мужской'' ELSE ''Женский'' END AS sex, ' +
    '  stud.civ, ' +
    '  stud.region, ' +
    '  stud.gorod, ' +
    '  stud.adr, ' +
    '  stud.passp_fam + '' '' + stud.passp_naim + ISNULL('' '' + stud.passp_otch, '''') AS fio, ' +
 '  CASE stud.mesto_jit WHEN 1 THEN ''Съем'' ELSE ''Общежитие'' END AS to_live, ' +
    '  stud.mod_t, ' +
    '  stud.dom_t, ' +
    '  stud.data_pr, ' +
    '  gruppa.naim_grup, ' +
    '  stud.st_email ' +
    'FROM stud ' +
    'INNER JOIN gruppa ON gruppa.grup_id = stud.grup_id ' +
    'INNER JOIN spec ON spec.spec_id = gruppa.spec_id ' +
    'WHERE 1=1 ' +
    '  AND stud.data_ot IS NULL ' +
    '  AND is_akadem = 0 ';
       Close;
       Open;
       Stud_report1Grid.Columns[0].Title.Caption := 'Номер порядковый';
  Stud_report1Grid.Columns[1].Title.Caption:='Дата рождения';
  Stud_report1Grid.Columns[2].Title.Caption:='Пол';
  Stud_report1Grid.Columns[3].Title.Caption:='Гражданство';
  Stud_report1Grid.Columns[4].Title.Caption:='Регион';
  Stud_report1Grid.Columns[5].Title.Caption:='Город';
  Stud_report1Grid.Columns[6].Title.Caption:='Адрес';
  Stud_report1Grid.Columns[7].Title.Caption:='ФИО';
  Stud_report1Grid.Columns[8].Title.Caption:='Проживание';
  Stud_report1Grid.Columns[9].Title.Caption:='Мобильный';
  Stud_report1Grid.Columns[10].Title.Caption:='Домашний';
  Stud_report1Grid.Columns[11].Title.Caption:='Дата приема';
  Stud_report1Grid.Columns[12].Title.Caption:='Группа';
  Stud_report1Grid.Columns[13].Title.Caption:='Email';
 end;
 end;
 1:
begin
   with dm.reportQuery do
   begin
    SQL.Clear;
    SQL.Text:='select '+
    '  stud.stud_id, ' +
    '  stud.b_data, ' +
    '  CASE stud.pol WHEN 1 THEN ''Мужской'' ELSE ''Женский'' END AS sex, ' +
    '  stud.civ, ' +
    '  stud.region, ' +
    '  stud.gorod, ' +
    '  stud.adr, ' +
    '  stud.passp_fam + '' '' + stud.passp_naim + ISNULL('' '' + stud.passp_otch, '''') AS fio, ' +
    ' gruppa.kurs,'+
 '  CASE stud.mesto_jit WHEN 1 THEN ''Съем'' ELSE ''Общежитие'' END AS to_live, ' +
    '  stud.mod_t, ' +
    '  stud.dom_t, ' +
    '  stud.data_pr, ' +
    '  gruppa.naim_grup, ' +
    '  stud.st_email ' +
    'FROM stud ' +
    'INNER JOIN gruppa ON gruppa.grup_id = stud.grup_id ' +
    'INNER JOIN spec ON spec.spec_id = gruppa.spec_id ' +
    'WHERE 1=1 ' +
    '  AND stud.data_ot IS NULL ' +
    '  AND is_akadem = 0 ';
    Close;
    Open;
    secondrepotGrid.Columns[0].Title.Caption:='Номер прядковый';
    secondrepotGrid.Columns[1].Title.Caption:='Дата рождения';
    secondrepotGrid.Columns[2].Title.Caption:='Пол';
    secondrepotGrid.Columns[3].Title.Caption:='Гражданство';
    secondrepotGrid.Columns[4].Title.Caption:='Регион';
end;
end;

 end; //case

end;

procedure TFrm_reports.seconreportBtnClick(Sender: TObject);
   var
   second_report:TADOStoredProc;
   I,cb,cbe:Integer;

begin
  second_report := nil;
  try
    second_report := TADOStoredProc.Create(nil);
    try
      with second_report do
      begin
        Connection := DM.Connection;
        if not Connection.Connected then
          raise Exception.Create('Соединение с базой не установлено');
        ProcedureName := 'second_report';
        Parameters.Clear;
        Parameters.CreateParameter(
        'grup_id',
        ftInteger,
        pdInput,
        0,
        r2groupDBL.KeyValue
        );
        Parameters.CreateParameter(
        't_date',
        ftDate,
        pdInput,
        0,
        r2_date_inp.Date
        );
        Open;
        DM.reportQuery.Close;
        DM.reportQuery.Recordset := second_report.Recordset;
      end;
    except
      on E: EADOError do
        ShowMessage('Ошибка: ' + E.Message);
      on E: Exception do
        ShowMessage('Ошибка: ' + E.Message);
    end;
  finally
    FreeAndNil(second_report);
  end;
   with secondrepotGrid do
   begin
     for I := 0 to columns.Count - 1 do
       begin
         Columns[i].Visible:=False;
       end;
   end;

 with Frm_reports do
 begin
    for cbe := 0 to ComponentCount - 1 do
 begin
    if(Components[cbe] is TCheckBox)  then
   begin
      (Components[cbe] as TCheckBox).Enabled:=true;
 end;
 end;
 end;
end;

procedure TFrm_reports.SexCBClick(Sender: TObject);
begin
 Stud_report1Grid.Columns[2].Visible:=sexCB.Checked;
 if SexCB.Checked then
  Stud_report1Grid.Columns[2].Title.Caption:='Пол';
end;

procedure TFrm_reports.stud_idCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[0].Visible := stud_idCB.Checked;
if stud_idCB.Checked then
  Stud_report1Grid.Columns[0].Title.Caption := 'Номер порядковый';
end;

procedure TFrm_reports.Stud_report1BtnClick(Sender: TObject);
var
 frist_report:TADOStoredProc;
  i,cb,cbe:Integer;
begin
    frist_report := nil;
  try
    frist_report := TADOStoredProc.Create(nil);
    try
      with frist_report do
      begin
        Connection := DM.Connection;
        if not Connection.Connected then
          raise Exception.Create('Соединенние с базой не установлено');
        ProcedureName := 'frist_report';
        Parameters.Clear;
        Parameters.CreateParameter(
        'stud_id',
        ftInteger,
        pdInput,
        0,
        Stud_report1DBL.KeyValue
        );
        Open;
        DM.reportQuery.Close;
        DM.reportQuery.Recordset := frist_report.Recordset;
      end;
    except
      on E: EADOError do
        ShowMessage('Ошибка: ' + E.Message);
      on E: Exception do
        ShowMessage('Ошибка: ' + E.Message);
    end;
  finally
    FreeAndNil(frist_report);
  end;
 with Stud_report1Grid do
 begin
  for I := 0 to Columns.Count - 1 do
  begin
    Columns[i].Visible:=False;
  end;
  end;
 MessageDlg('Таблица скрыта,отчет формирутеся динамически',mtInformation,
 [mbOK],0);
 with Frm_reports do
 begin
    for cb := 0 to ComponentCount - 1 do
 begin
    if(Components[cb] is TCheckBox)  then
   begin
      (Components[cb] as TCheckBox).Checked:=False;
 end;
 end;
 end;
   with Frm_reports do
 begin
    for cbe := 0 to ComponentCount - 1 do
 begin
    if(Components[cbe] is TCheckBox)  then
   begin
      (Components[cbe] as TCheckBox).Enabled:=true;
 end;
 end;
 end;



end;


procedure TFrm_reports.st_emailCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[13].Visible:=st_emailCB.Checked;
  if st_emailCB.Checked then
  Stud_report1Grid.Columns[13].Title.Caption:='Email';
end;

procedure TFrm_reports.to_liveCBClick(Sender: TObject);
begin
Stud_report1Grid.Columns[8].Visible:=to_liveCB.Checked;
if to_liveCB.Checked then
 Stud_report1Grid.Columns[8].Title.Caption:='Проживание';
end;

end.
